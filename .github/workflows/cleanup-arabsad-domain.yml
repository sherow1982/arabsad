name: ğŸš€ Clean up arabsad.com from all repos

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-mode (no actual changes)'
        required: false
        default: 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: [
          'arabsad',
          'arabic-ads',
          'arabic-ads-calculator-tools',
          'sooq-alemarat',
          'sooq-oman',
          'sooq-masr',
          'sooq-Jordan',
          'sooq-qatar',
          'emirates-gifts',
          'amazing-uae',
          'Iraq-Store',
          'iraq-ninja-store',
          'alsooq-alsaudi',
          'alsooq-alqatary',
          'matjar-oman',
          'Emirates-shopping',
          'Kuwait-matjar',
          'hadaya-emirates.arabsad.com',
          'mahkzoon-alsaudia',
          'matjar-makhzoon-alemarat',
          'matjar-makhzoon-oman',
          'matager-makhzoon-alemarat',
          'store-ideal',
          'safahat-khadamat',
          'aqarat'
        ]
    steps:
      - name: âœ… Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: sherow1982/${{ matrix.repo }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ§ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸš€ Run domain cleanup
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          python3 << 'EOF'
          import os
          import re
          from pathlib import Path
          
          dry_run = os.environ.get('DRY_RUN', 'false').lower() == 'true'

          # Configuration
          # Define replacements (raw)
          RAW_REPLACEMENTS = {
              'https://www.arabsad.com': 'https://sherow1982.github.io',
              'https://arabsad.com': 'https://sherow1982.github.io',
              'www.arabsad.com': 'sherow1982.github.io',
              'arabsad.com': 'sherow1982.github.io',
              'hadaya-emirates.arabsad.com': 'sherow1982.github.io/hadaya-emirates',
              'https://hadaya-emirates.arabsad.com': 'https://sherow1982.github.io/hadaya-emirates',
              'http://hadaya-emirates.arabsad.com': 'https://sherow1982.github.io/hadaya-emirates',
          }
          
          # Sort by length descending to ensure subdomains are handled before the root domain
          REPLACEMENTS = dict(sorted(RAW_REPLACEMENTS.items(), key=lambda x: len(x[0]), reverse=True))

          ALLOWED_EXTENSIONS = {
              '.html', '.htm', '.css', '.js', '.json', '.md', '.txt',
              '.xml', '.svg', '.py', '.sh', '.yaml', '.yml', '.htaccess'
          }
          
          SKIP_PATTERNS = ['.git', '__pycache__', '.github/workflows', 'node_modules']
          
          modified_files = []
          total_replacements = 0
          
          def should_process(file_path):
              if file_path.suffix.lower() not in ALLOWED_EXTENSIONS:
                  return False
              for pattern in SKIP_PATTERNS:
                  if pattern in str(file_path):
                      return False
              return file_path.is_file()
          
          for file_path in Path('.').rglob('*'):
              if should_process(file_path):
                  try:
                      with open(file_path, 'r', encoding='utf-8', errors='replace') as f:
                          content = f.read()
                      
                      original = content
                      file_replacements_count = 0
                      for old, new in REPLACEMENTS.items():
                          pattern = re.compile(re.escape(old), re.IGNORECASE)
                          matches = len(pattern.findall(content))
                          if matches > 0:
                              content = pattern.sub(new, content)
                              file_replacements_count += matches
                      
                      if content != original:
                          if not dry_run:
                              with open(file_path, 'w', encoding='utf-8') as f:
                                  f.write(content)
                          modified_files.append(str(file_path))
                          total_replacements += file_replacements_count
                  except Exception as e:
                      print(f"âš ï¸  Error processing {file_path}: {e}")
                      continue)
          
          action_verb = "Would modify" if dry_run else "Modified"
          print(f"\nâœ… {action_verb} {len(modified_files)} files")
          print(f"ğŸ“Š Total replacements: {total_replacements}")
          
          if modified_files:
              print(f"\nğŸ“ {action_verb} files:")
              for f in modified_files:
                  print(f"   - {f}")
          EOF

      - name: ğŸ“¤ Commit changes
        if: inputs.dry_run != 'true'
        continue-on-error: true
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff-index --quiet HEAD --; then
            echo "âœ… No changes detected"
          else
            git commit -m "ğŸš€ Remove arabsad.com references - migrate to GitHub Pages"
            git push
            echo "âœ… Changes pushed to ${{ matrix.repo }}"
          fi

      - name: ğŸš Report
        if: always()
        run: |
          echo "ğŸš Cleanup completed for ${{ matrix.repo }}"
          echo "Repository: https://github.com/sherow1982/${{ matrix.repo }}"
